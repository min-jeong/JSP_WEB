package com.ktds.jmj.web;

import java.io.IOException;
import java.util.Arrays;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.ktds.jmj.dao.ActorDAO;
import com.ktds.jmj.dao.DirectorDAO;
import com.ktds.jmj.dao.GenreDAO;
import com.ktds.jmj.dao.MovieDAO;
import com.ktds.jmj.vo.ActorVO;
import com.ktds.jmj.vo.DirectorVO;
import com.ktds.jmj.vo.GenreVO;
import com.ktds.jmj.vo.MovieVO;

/**
 * Servlet implementation class AddNewMovieActionServlet
 */
public class AddNewMovieActionServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;
	private MovieDAO movieDAO;
	private GenreDAO genreDAO;
	private ActorDAO actorDAO;
	private DirectorDAO directorDAO;
	
       
    /**
     * @see HttpServlet#HttpServlet()
     */
    public AddNewMovieActionServlet() {
        super();
        movieDAO = new MovieDAO();
        genreDAO = new GenreDAO();
        actorDAO = new ActorDAO();
        directorDAO = new DirectorDAO();
        // TODO Auto-generated constructor stub
    }

	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		response.sendError(HttpServletResponse.SC_FORBIDDEN, "잘못된 요청입니다.");
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
		
		//jsp에서의 name이 파라미터의 키이다.
		String movieTitle = request.getParameter("movieTitle");
		String rate = request.getParameter("rate");
		String runningTime = request.getParameter("runningTime");
		String openDate = request.getParameter("openDate");
		String grade = request.getParameter("grade");
		
		List<String> directors = Arrays.asList(request.getParameterValues("directors")); //.getParameterValues로 여러개 받아와서 배열을 리스트로 바꾼다.
		// select는 원래 getParameterValues 안쓰지만 multiple때문에 써줬다.
		
		List<String> actors = Arrays.asList(request.getParameter("actors"));
		
		List<String> genres = Arrays.asList(request.getParameter("genres")); // checkbox는 100%컬랙션이다.
		
		
		if ( movieTitle == null || movieTitle.length() == 0 ){ // 입력하지 않았다면
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_MOVIE_TITLE);
			return;
		}
		if (rate == null || rate.length() == 0 ) {
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_RATE);
			return;
		}
		try{
			double ratePoint = Double.parseDouble(rate);
		}
		catch(NumberFormatException nfe){
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_RATE);
			return;
		}
		
		if (runningTime == null || runningTime.length() == 0 ) {
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_RUNNING_TIME);
			return;
		}
		if( runningTime.length() > 5 ) {
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_RUNNING_TIME);
			return;
		}
		Pattern p = Pattern.compile("^[0-2][0-9]:[0-5][0-9]$"); // 정규표현식 검사
		Matcher m = p.matcher(runningTime);
		
		if ( ! m.matches() ) {
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_RUNNING_TIME);
			return;
		}
		
		if (openDate == null || openDate.length() == 0 ) {
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_OPEN_DATE);
			return;
		}
		
		if ( grade == null || grade.length() == 0 ) {
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_GRADE);
			return;
		}
		
		if ( directors == null || directors.size() == 0 ) {
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_DIRECTORS);
			return;
		}
		
		if ( actors == null || actors.size() == 0 ) {
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_ACTORS);
			return;
		}
		
		if ( genres == null || genres.size() == 0 ) {
			response.sendRedirect("/Movie/addNewMovie?errorCode=" + MovieValidateConst.MISSING_GENRES);
			return;
		}
		
		MovieVO movie = new MovieVO();
		movie.setTitle(movieTitle);
		movie.setRate(Double.parseDouble(rate));
		movie.setRunningTime(runningTime);
		movie.setOpenDate(openDate);
		movie.setGradeId(Integer.parseInt(grade));
		
		int newMovieId = movieDAO.insertNewMovie(movie);
		
		if ( newMovieId > 0) {
			GenreVO genre = new GenreVO();
			ActorVO actor = new ActorVO();
			DirectorVO director = new DirectorVO();	
		}
		
			
		
	}

}
